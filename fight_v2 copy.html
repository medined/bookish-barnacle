<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Overwatch Hero Attack — v2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #0c1116;
        --panel: #0f1823;
        --border: #1f2937;
        --muted: #97a0b4;
        --accent: #9bdbff;
        --accent-strong: #4dc2ff;
        --text: #e6edf3;
        --danger: #f66a4b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          "Segoe UI",
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        background: radial-gradient(circle at 20% 20%, #132034 0, #0c131e 35%, #0b1119 70%);
        color: var(--text);
      }
      main {
        max-width: 1080px;
        margin: 0 auto;
        padding: 28px 20px 48px;
      }
      header h1 {
        margin: 0 0 8px;
        font-size: 2.1rem;
        letter-spacing: 0.01em;
      }
      header p {
        margin: 0 0 18px;
        color: var(--muted);
      }
      .panel {
        border: 1px solid var(--border);
        background: var(--panel);
        border-radius: 14px;
        padding: 16px;
      }
      form.controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 14px;
        align-items: end;
        margin-bottom: 18px;
      }
      form label {
        display: block;
        font-size: 0.85rem;
        margin-bottom: 4px;
        color: var(--muted);
      }
      select,
      button {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        background: #0c1116;
        color: var(--text);
        font-size: 1rem;
      }
      button {
        background: var(--accent);
        color: #04111d;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease;
        box-shadow: 0 6px 18px rgba(77, 194, 255, 0.2);
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 26px rgba(77, 194, 255, 0.28);
      }
      .hero-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
        margin-bottom: 18px;
      }
      .hero-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        background: #0c131d;
      }
      .hero-card h2 {
        margin: 0 0 8px;
        font-size: 1.6rem;
      }
      .hero-card .hero-name {
        color: #ffd54f;
        font-size: 1.2em;
        font-weight: 700;
      }
      .hero-card .hero-role {
        font-size: 0.65em;
        font-weight: 600;
        text-transform: uppercase;
      }
      .hero-card span {
        color: var(--muted);
        font-size: 0.9rem;
        margin-left: 6px;
      }
      .hero-card p {
        margin: 2px 0;
        color: var(--muted);
        font-size: 0.92rem;
      }
      .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
        margin-top: 6px;
      }
      .metric {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #0c131d;
      }
      .metric h4 {
        margin: 0 0 6px;
        font-size: 0.95rem;
        color: var(--muted);
      }
      .metric strong {
        font-size: 1.2rem;
      }
      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }
      .warning {
        color: var(--danger);
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>Hero Attack Calculator (v2)</h1>
        <p>Select an attacker and a defender. Stats come from <code>data-hero-details.csv</code>; the time-to-kill is calculated using the v2 training-dummy algorithm.</p>
      </header>

      <section class="panel">
        <form id="fightForm" class="controls">
          <div>
            <label for="attackerSelect">Attacker</label>
            <select id="attackerSelect" required></select>
          </div>
          <div>
            <label for="defenderSelect">Defender (training dummy)</label>
            <select id="defenderSelect" required></select>
          </div>
        </form>

        <div class="hero-grid">
          <div class="hero-card" id="attackerCard"></div>
          <div class="hero-card" id="defenderCard"></div>
        </div>

        <div class="summary" id="summary"></div>
        <p class="muted" id="note"></p>
      </section>
    </main>

    <script id="csv-inline" type="text/csv">
role,name,damage_per_bullet,bullets_per_shot,fire_rate,reload_time,ammo,armor_piercing,health,shields,armor
Tank,D.Va,2,11,6.67,0,,True,225,0,325
Tank,Doomfist,5,11,3,0.4,4,True,375,0,0
Tank,Hazard,7.5,10,1.75,2.3,8,True,275,0,225
Tank,Junker Queen,8,10,1.33,1.5,8,True,375,0,0
Tank,Mauga,4,1,18,2.2,300,True,425,0,150
Tank,Orisa,14,1,10,3,,True,150,0,300
Tank,Ramattra,5,1,25,1,100,True,250,0,100
Tank,Reinhardt,100,1,1.04,0,,True,250,0,300
Tank,Roadhog,6.5,25,1.25,1.5,6,True,600,0,0
Tank,Sigma,15,2,0.67,0,,True,200,275,0
Tank,Winston,70,1,1,1.7,120,True,275,0,200
Tank,Wrecking Ball,5,1,25,1.6,80,True,300,150,175
Tank,Zarya,95,1,1,1.5,100,True,175,225,0
Damage,Ashe,35,1,3.9,0.5,12,True,250,0,0
Damage,Bastion,25,1,5,1.2,25,True,250,0,100
Damage,Cassidy,70,1,2,1.5,6,True,250,0,0
Damage,Echo,17,3,2.97,1.5,12,True,150,75,0
Damage,Freja,25,1,4.81,1.6,15,True,225,0,0
Damage,Genji,27,3,1.14,1.5,24,True,250,0,0
Damage,Hanzo,125,1,2,0,,True,250,0,0
Damage,Junkrat,45,1,1.5,1.5,5,True,250,0,0
Damage,Mei,5,1,20,1.5,140,True,300,0,0
Damage,Pharah,40,1,1.25,1.5,6,True,225,0,0
Damage,Reaper,5.75,20,2,1.5,8,True,300,0,0
Damage,Sojourn,9,1,16,1.2,45,True,225,0,0
Damage,Soldier: 76,19,1,9,1.5,30,True,250,0,0
Damage,Sombra,8,1,20,1.2,60,True,225,0,0
Damage,Symmetra,60,1,1,1.5,100,True,125,150,0
Damage,Torbjörn,70,1,1.96,2,18,True,225,0,75
Damage,Tracer,6,2,20,1,40,True,175,0,0
Damage,Venture,35,1,1.67,1.75,8,True,250,0,0
Damage,Widowmaker,14,1,10,1.5,35,True,225,0,0
Support,Ana,75,1,1.25,1.5,15,True,250,0,0
Support,Baptiste,25,3,1.7,1.5,36,True,250,0,0
Support,Brigitte,45,1,1.667,0,,True,200,0,50
Support,Illari,70,1,2,1.5,14,True,250,0,0
Support,Juno,7.5,12,1.29,1.5,180,True,75,150,0
Support,Kiriko,60,1,2,1,15,True,225,0,0
Support,Lifeweaver,6,2,11,1.5,100,True,200,50,0
Support,Lúcio,20,4,1.07,1.5,20,True,225,0,0
Support,Mercy,20,1,5,1.4,25,True,225,0,0
Support,Moira,65,1,1,0,,True,225,0,0
Support,Wuyang,10,1,3,1.5,20,True,225,0,0
Support,Zenyatta,50,1,2.5,1.5,25,True,75,175,0
    </script>
    <script>
      const csvPath = "data-hero-details.csv";

      async function loadCsv(path) {
        const inline = document.getElementById("csv-inline")?.textContent?.trim();
        try {
          const response = await fetch(path);
          if (response.ok) {
            const text = await response.text();
            if (text.trim()) {
              return text;
            }
          }
        } catch (err) {
          // fall back to inline data below
        }
        if (inline) {
          return inline;
        }
        throw new Error(`Failed to load ${path}`);
      }

      function parseCsv(text) {
        const lines = text
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter(Boolean);
        const [headerLine, ...rows] = lines;
        const headers = headerLine.split(",");
        return rows.map((line) => {
          const cols = line.split(",");
          const record = {};
          headers.forEach((h, i) => {
            record[h] = cols[i] ?? "";
          });
          return {
            role: record.role,
            name: record.name,
            damagePerBullet: parseFloat(record.damage_per_bullet) || 0,
            bulletsPerShot: parseFloat(record.bullets_per_shot) || 1,
            fireRate: parseFloat(record.fire_rate) || 0,
            reloadTime: parseFloat(record.reload_time) || 0,
            ammo: record.ammo === "" ? Infinity : parseFloat(record.ammo),
            armorPiercing: String(record.armor_piercing).toLowerCase() === "true",
            health: parseFloat(record.health) || 0,
            shields: parseFloat(record.shields) || 0,
            armor: parseFloat(record.armor) || 0,
          };
        });
      }

      function armorMitigationPerBullet(damage, armorPiercing) {
        if (armorPiercing) return damage;
        if (damage < 14) return damage * 0.5;
        return damage - 7;
      }

      function computeTimeToKill(attacker, defender) {
        const damage = attacker.damagePerBullet;
        if (damage <= 0 || attacker.bulletsPerShot <= 0 || attacker.fireRate <= 0) {
          return { seconds: Infinity, bullets: Infinity, reloads: 0, note: "Missing or zeroed weapon stats." };
        }

        const mitigation = armorMitigationPerBullet(damage, attacker.armorPiercing);
        const armorProtection = mitigation > 0 ? defender.armor / mitigation : 0;
        const bulletsTilDeath = Math.ceil((defender.health + defender.shields) / damage + armorProtection);

        let reloads = 0;
        if (Number.isFinite(attacker.ammo) && attacker.ammo > 0) {
          reloads = Math.floor(bulletsTilDeath / attacker.ammo);
          if (bulletsTilDeath % attacker.ammo === 0) reloads -= 1;
          reloads = Math.max(0, reloads);
        }

        const reloadTimeTaken = reloads * attacker.reloadTime;
        const shotsTilDeath = Math.ceil(bulletsTilDeath / attacker.bulletsPerShot);
        const secondsTilDeath = shotsTilDeath / attacker.fireRate + reloadTimeTaken;

        return {
          seconds: secondsTilDeath,
          bullets: bulletsTilDeath,
          reloads,
        };
      }

      function renderHeroCard(el, hero, title) {
        if (!hero) {
          el.innerHTML = `<h2>${title}</h2><p class="muted">Select a hero to see details.</p>`;
          return;
        }
        const lines =
          title === "Attacker"
            ? [
                `Damage per bullet: ${hero.damagePerBullet}`,
                `Bullets per shot: ${hero.bulletsPerShot}`,
                `Fire rate: ${hero.fireRate} shots/s`,
                `Reload time: ${hero.reloadTime || 0}s`,
                `Ammo: ${Number.isFinite(hero.ammo) ? hero.ammo : "∞"}`,
                `Armor piercing: ${hero.armorPiercing ? "yes" : "no"}`,
              ]
            : [
                `Health: ${hero.health}`,
                `Shields: ${hero.shields}`,
                `Armor: ${hero.armor}`,
              ];
        const heading = `<h2><span class="hero-name">${hero.name}</span> <span class="hero-role">${title}</span></h2>`;
        el.innerHTML = `${heading}${lines.map((line) => `<p>${line}</p>`).join("")}`;
      }

      function renderSummary(result, attacker, defender) {
        const summary = document.getElementById("summary");
        const noteEl = document.getElementById("note");
        if (!attacker || !defender) {
          summary.innerHTML = "";
          noteEl.textContent = "";
          return;
        }
        if (!result || !isFinite(result.seconds)) {
          summary.innerHTML = `<div class="metric"><h4>Time to kill</h4><strong class="warning">N/A</strong></div>`;
          noteEl.textContent = "Unable to compute: missing stats for attacker.";
          return;
        }
        summary.innerHTML = `
          <div class="metric">
            <h4>Time to kill</h4>
            <strong>${result.seconds.toFixed(2)} s</strong>
          </div>
          <div class="metric">
            <h4>Bullets needed</h4>
            <strong>${result.bullets}</strong>
            <div class="muted">Reloads: ${result.reloads}</div>
          </div>
        `;
        noteEl.textContent = "Armor mitigation is applied per-bullet using the v2 training dummy assumptions.";
      }

      async function init() {
        const text = await loadCsv(csvPath);
        const heroes = parseCsv(text);
        const attackerSelect = document.getElementById("attackerSelect");
        const defenderSelect = document.getElementById("defenderSelect");

        heroes.forEach((hero) => {
          const optA = document.createElement("option");
          optA.value = hero.name;
          optA.textContent = hero.name;
          const optB = optA.cloneNode(true);
          attackerSelect.appendChild(optA);
          defenderSelect.appendChild(optB);
        });

        attackerSelect.selectedIndex = 0;
        defenderSelect.selectedIndex = heroes.length > 1 ? 1 : 0;

        const attackerCard = document.getElementById("attackerCard");
        const defenderCard = document.getElementById("defenderCard");
        const form = document.getElementById("fightForm");

        function update() {
          const attacker = heroes.find((h) => h.name === attackerSelect.value);
          const defender = heroes.find((h) => h.name === defenderSelect.value);
          renderHeroCard(attackerCard, attacker, "Attacker");
          renderHeroCard(defenderCard, defender, "Defender");
          const result = attacker && defender ? computeTimeToKill(attacker, defender) : null;
          renderSummary(result, attacker, defender);
        }

        attackerSelect.addEventListener("change", update);
        defenderSelect.addEventListener("change", update);
        form.addEventListener("submit", (event) => {
          event.preventDefault();
        });

        update();
      }

      init().catch((err) => {
        document.getElementById("summary").innerHTML =
          '<div class="metric"><h4>Error</h4><strong class="warning">Could not load hero data.</strong></div>';
        console.error(err);
      });
    </script>
  </body>
</html>
